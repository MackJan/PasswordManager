{% extends "master.html" %}

{% block title %}
Password Manager Vault
{% endblock %}

{% block content %}
<head>
    <title>Password Manager - Vault</title>
    <script>
        // When the user clicks on <div>, open the popup
        function showPopup() {
            let popup = document.getElementById("item-popup");
            let backdrop = document.getElementById("popup-backdrop");
            popup.classList.add("show");
            backdrop.classList.add("show");
        }

        // Show edit popup for specific item
        function showEditPopup(itemId) {
            let popup = document.getElementById("edit-item-" + itemId);
            let backdrop = document.getElementById("popup-backdrop");
            popup.classList.add("show");
            backdrop.classList.add("show");
        }

        // Close the popup
        function closePopup() {
            let popup = document.getElementById("item-popup");
            let backdrop = document.getElementById("popup-backdrop");
            let editPopups = document.querySelectorAll('.edit-popup');
            let deletePopup = document.getElementById("delete-confirmation-popup");
            popup.classList.remove("show");
            backdrop.classList.remove("show");
            deletePopup.classList.remove("show");
            for (const editPopup of editPopups) {
                editPopup.classList.remove("show");
            }
        }

        // Close popup when clicking outside of it
        globalThis.onclick = function (event) {
            let backdrop = document.getElementById("popup-backdrop");
            if (event.target === backdrop) {
                closePopup();
            }
        }

        // Show delete confirmation popup
        function confirmDelete(itemId, itemName) {
            let popup = document.getElementById("delete-confirmation-popup");
            let backdrop = document.getElementById("popup-backdrop");
            let itemNameSpan = document.getElementById("delete-item-name");
            let confirmBtn = document.getElementById("confirm-delete-btn");

            // Set the item name in the popup
            itemNameSpan.textContent = itemName;

            // Set up the confirm button to submit the correct form
            confirmBtn.onclick = function() {
                document.getElementById('delete-form-' + itemId).submit();
            };

            // Show the popup
            popup.classList.add("show");
            backdrop.classList.add("show");
        }

        // Toggle password visibility
        function togglePassword(itemId) {
            let item = document.getElementById(itemId);
            if(item.classList.contains('hidden')) {
                item.classList.remove('hidden');
            }
            else{
                item.classList.add('hidden');
            }
        }

        // Cancel delete action
        function cancelDelete() {
            closePopup();
        }
    </script>
</head>
<div class="hero-section">
    <div class="hero-title">
        <h1>Password Manager Vault</h1>
    </div>

    <h2 class="hero-subtitle">Welcome to Your Vault</h2>
    <p class="hero-subtitle">Here you can see and manage your stored passwords</p>

    <div class="vault-items-container">
        <!-- Display error/success messages -->
        {% if messages %}
        <div class="alert alert-primary" role="alert">
            {% for message in messages %}
            {{ message }}
            {% endfor %}
        </div>
        {% endif %}

        {% for item in items %}
        <div class="vault-item">
            <div class="item-info">
                <div class="item-field">
                    <span class="item-label">Name</span>
                    <span class="item-value item-title">{{ item.name }}</span>
                </div>
                <div class="item-field">
                    <span class="item-label">Username</span>
                    <span class="item-value item-username">{{ item.username }}</span>
                </div>
                <div class="item-field">
                    <span class="item-label">Password</span>
                    <span id="{{ item.id }}" class="item-value item-password hidden">
                        <span class="password-text">{{ item.password }}</span>
                    </span>
                </div>
                {% if item.url %}
                <div class="item-field">
                    <span class="item-label">URL</span>
                    <span class="item-value item-url">{{ item.url }}</span>
                </div>
                {% endif %}
                {% if item.notes %}
                <div class="item-field">
                    <span class="item-label">Notes</span>
                    <span class="item-value item-notes">{{ item.notes }}</span>
                </div>
                {% endif %}
                <div class="item-actions">
                    <button class="btn btn-primary" onclick="togglePassword('{{ item.id }}')">Show</button>
                    <button class="btn btn-primary" onclick="showEditPopup('{{ item.id }}')">Edit</button>
                    <button class="btn btn-danger" onclick="confirmDelete('{{ item.id }}', '{{ item.name }}')">Delete</button>
                </div>
            </div>
        </div>

        <!-- Hidden delete form for each item -->
        <form id="delete-form-{{ item.id }}" method="post" style="display: none;">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete">
            <input type="hidden" name="id" value="{{ item.id }}">
        </form>

        <!-- Edit popup for each item -->
        <div id="edit-item-{{ item.id }}" class="edit-popup">
            <div class="form-container">
                <button onclick="closePopup()" class="close-button">&times;</button>
                <h2 class="form-title">Edit Vault Item "{{ item.name }}"</h2>

                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" name="id" value="{{ item.id }}">

                    <div class="form-group">
                        <label for="edit-name-{{ item.id }}">Name</label>
                        <input type="text" class="form-control" name="name" id="edit-name-{{ item.id }}"
                               placeholder="Enter the Items name" value="{{ item.name }}" required>
                    </div>

                    <div class="form-group">
                        <label for="edit-username-{{ item.id }}">Username</label>
                        <input type="text" class="form-control" name="username" id="edit-username-{{ item.id }}"
                               placeholder="Enter the Items username" value="{{ item.username }}" required>
                    </div>

                    <div class="form-group">
                        <label for="edit-password-{{ item.id }}">Password</label>
                        <input type="password" name="password" class="form-control" id="edit-password-{{ item.id }}"
                               placeholder="Enter the password to store" value="{{ item.password }}" required>
                    </div>

                    <div class="form-group">
                        <label for="edit-url-{{ item.id }}">URL</label>
                        <input type="url" class="form-control" name="url" id="edit-url-{{ item.id }}"
                               placeholder="Enter the website URL" value="{{ item.url }}">
                    </div>

                    <div class="form-group">
                        <label for="edit-notes-{{ item.id }}">Notes</label>
                        <textarea class="form-control" name="notes" id="edit-notes-{{ item.id }}"
                                  placeholder="Enter any additional notes" rows="3">{{ item.notes }}</textarea>
                    </div>

                    <button type="submit" class="form-button">Update Item</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>

    <button class="btn btn-primary popup" onclick="showPopup()">Add Item</button>

    <!-- Backdrop overlay -->
    <div id="popup-backdrop" class="popup-backdrop"></div>

    <!-- Create item popup -->
    <div id="item-popup">
        <div class="form-container">
            <button onclick="closePopup()" class="close-button">&times;</button>
            <div class="form-title">
                <h1>Item Creation</h1>
            </div>
            <h2 class="form-subtitle">Add a Vault Item</h2>

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="create">

                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" class="form-control" name="name" id="name"
                           placeholder="Enter the Items name" required>
                </div>

                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" class="form-control" name="username" id="username"
                           placeholder="Enter the Items username" required>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" name="password" class="form-control" id="password"
                           placeholder="Enter the password to store" required>
                </div>

                <div class="form-group">
                    <label for="url">URL</label>
                    <input type="url" class="form-control" name="url" id="url"
                           placeholder="Enter the website URL">
                </div>

                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea class="form-control" name="notes" id="notes"
                              placeholder="Enter any additional notes" rows="3"></textarea>
                </div>

                <button type="submit" class="form-button">Create Item</button>
            </form>
        </div>
    </div>

    <!-- Delete confirmation popup -->
    <div id="delete-confirmation-popup" class="delete-popup">
        <div class="delete-container">
            <button onclick="closePopup()" class="close-button">&times;</button>
            <div class="delete-title">
                <h1>⚠️ Confirm Deletion</h1>
            </div>
            <div class="delete-message">
                <p>Are you sure you want to delete "<span id="delete-item-name"></span>"?</p>
                <p class="warning-text">This action cannot be undone.</p>
            </div>
            <div class="delete-actions">
                <button type="button" class="btn btn-secondary" onclick="cancelDelete()">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}