{% extends "master.html" %}
{% load static %}

{% block title %}Vault{% endblock %}

{% block content %}
<section class="page-header">
    <div>
        <h1 class="page-title">Password vault</h1>
        <p class="page-description">Review, reveal, and update stored credentials. Everything stays encrypted until you choose to view it.</p>
    </div>
    <div class="page-actions">
        <button type="button" class="btn btn-primary" data-modal-open="create-item">
            <svg class="icon" aria-hidden="true" focusable="false">
                <use href="{% static 'img/icons/add.svg#icon-add' %}"></use>
            </svg>
            New item
        </button>
    </div>
</section>

<section class="card table-card">
    <div class="table-toolbar">
        <label class="search-field" for="vault-search">
            <svg class="icon" aria-hidden="true" focusable="false">
                <use href="{% static 'img/icons/search.svg#icon-search' %}"></use>
            </svg>
            <input id="vault-search" type="search" placeholder="Search vault" data-filter="vault" aria-label="Filter saved credentials">
        </label>
        <span class="badge">{{ items|length }} saved</span>
    </div>
    {% if items %}
    <table class="vault-table" role="grid">
        <thead>
            <tr>
                <th scope="col">Name</th>
                <th scope="col">Username</th>
                <th scope="col">Password</th>
                <th scope="col">URL</th>
                <th scope="col">Notes</th>
                <th scope="col"><span class="visually-hidden">Actions</span></th>
            </tr>
        </thead>
        <tbody>
        {% for item in items %}
            <tr data-vault-row data-search="{{ item.name }} {{ item.username }} {{ item.url }} {{ item.notes|default:'' }}">
                <td data-label="Name">
                    <strong>{{ item.name }}</strong>
                </td>
                <td data-label="Username">
                    <span>{{ item.username }}</span>
                </td>
                <td data-label="Password">
                    <div class="password-field" id="password-field-{{ item.id }}" data-visible="false">
                        <span class="password-text" id="password-text-{{ item.id }}">{{ item.password }}</span>
                    </div>
                    <div class="action-group">
                        <button type="button" class="btn btn-secondary" data-toggle-password="password-field-{{ item.id }}" data-eye-on="{% static 'img/icons/eye.svg#icon-eye' %}" data-eye-off="{% static 'img/icons/eye-off.svg#icon-eye-off' %}" aria-pressed="false">
                            <svg class="icon" aria-hidden="true" focusable="false">
                                <use href="{% static 'img/icons/eye.svg#icon-eye' %}"></use>
                            </svg>
                            <span data-toggle-label>Reveal</span>
                        </button>
                        <button type="button" class="btn btn-secondary" data-copy="password-text-{{ item.id }}">
                            <svg class="icon" aria-hidden="true" focusable="false">
                                <use href="{% static 'img/icons/copy.svg#icon-copy' %}"></use>
                            </svg>
                            Copy
                        </button>
                    </div>
                </td>
                <td data-label="URL" class="cell-muted">
                    {% if item.url %}
                        <a href="{{ item.url }}" target="_blank" rel="noopener" class="btn btn-ghost">Visit</a>
                    {% else %}
                        <span>—</span>
                    {% endif %}
                </td>
                <td data-label="Notes" class="cell-muted">
                    {% if item.notes %}
                        {{ item.notes }}
                    {% else %}
                        <span>—</span>
                    {% endif %}
                </td>
                <td data-label="Actions">
                    <div class="action-group">
                        <button type="button" class="btn btn-secondary" data-modal-open="edit-{{ item.id }}">
                            <svg class="icon" aria-hidden="true" focusable="false">
                                <use href="{% static 'img/icons/edit.svg#icon-edit' %}"></use>
                            </svg>
                            Edit
                        </button>
                        <button type="button" class="btn btn-danger" data-modal-open="delete-item" data-item-name="{{ item.name }}" data-form-id="delete-form-{{ item.id }}">
                            <svg class="icon" aria-hidden="true" focusable="false">
                                <use href="{% static 'img/icons/trash.svg#icon-trash' %}"></use>
                            </svg>
                            Delete
                        </button>
                    </div>
                </td>
            </tr>
            <form id="delete-form-{{ item.id }}" method="post" class="visually-hidden">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="id" value="{{ item.id }}">
            </form>

            <div class="modal" data-modal="edit-{{ item.id }}" aria-hidden="true" role="dialog" aria-modal="true">
                <div class="modal-panel">
                    <div class="modal-header">
                        <h2>Edit {{ item.name }}</h2>
                        <button type="button" class="modal-close" data-modal-close aria-label="Close">
                            <svg class="icon" aria-hidden="true" focusable="false">
                                <use href="{% static 'img/icons/x.svg#icon-x' %}"></use>
                            </svg>
                        </button>
                    </div>
                    <form method="post" class="form-grid">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="edit">
                        <input type="hidden" name="id" value="{{ item.id }}">
                        <label>
                            Name
                            <input type="text" name="name" value="{{ item.name }}" required autocomplete="off">
                        </label>
                        <label>
                            Username
                            <input type="text" name="username" value="{{ item.username }}" required autocomplete="off">
                        </label>
                        <label>
                            Password
                            <input type="password" name="password" value="{{ item.password }}" required autocomplete="off">
                        </label>
                        <label>
                            URL
                            <input type="url" name="url" value="{{ item.url }}" autocomplete="off">
                        </label>
                        <label>
                            Notes
                            <textarea name="notes" rows="3">{{ item.notes }}</textarea>
                        </label>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-ghost" data-modal-close>Cancel</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <svg class="icon" aria-hidden="true" focusable="false">
            <use href="{% static 'img/icons/lock.svg#icon-lock' %}"></use>
        </svg>
        <p>No credentials stored yet. Create your first item to get started.</p>
        <button type="button" class="btn btn-primary" data-modal-open="create-item">Add item</button>
    </div>
    {% endif %}
</section>

<div class="modal" data-modal="create-item" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-panel">
        <div class="modal-header">
            <h2>Add vault item</h2>
            <button type="button" class="modal-close" data-modal-close aria-label="Close">
                <svg class="icon" aria-hidden="true" focusable="false">
                    <use href="{% static 'img/icons/x.svg#icon-x' %}"></use>
                </svg>
            </button>
        </div>
        <form method="post" class="form-grid">
            {% csrf_token %}
            <input type="hidden" name="action" value="create">
            <label>
                Name
                <input type="text" name="name" required autocomplete="off" data-initial-focus>
            </label>
            <label>
                Username
                <input type="text" name="username" required autocomplete="off">
            </label>
            <label>
                Password
                <input type="password" name="password" required autocomplete="off">
            </label>
            <label>
                URL
                <input type="url" name="url" autocomplete="off">
            </label>
            <label>
                Notes
                <textarea name="notes" rows="3"></textarea>
            </label>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" data-modal-close>Cancel</button>
                <button type="submit" class="btn btn-primary">Create item</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" data-modal="delete-item" aria-hidden="true" role="alertdialog" aria-modal="true">
    <div class="modal-panel">
        <div class="modal-header">
            <h2>Confirm deletion</h2>
            <button type="button" class="modal-close" data-modal-close aria-label="Close">
                <svg class="icon" aria-hidden="true" focusable="false">
                    <use href="{% static 'img/icons/x.svg#icon-x' %}"></use>
                </svg>
            </button>
        </div>
        <p>You're about to delete <strong data-delete-name></strong>. This action cannot be undone.</p>
        <div class="modal-footer">
            <button type="button" class="btn btn-ghost" data-modal-close>Cancel</button>
            <button type="button" class="btn btn-danger" data-confirm-delete>Delete</button>
        </div>
    </div>
</div>
{% endblock %}
